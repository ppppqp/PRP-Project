{"ast":null,"code":"import * as d3 from \"d3\";\nimport { select, geoNaturalEarth1, scaleSqrt, max, format, selectAll, tsv, json } from \"d3\";\nimport d3Tip from \"d3-tip\";\nimport { feature } from \"topojson\";\nimport \"./style.css\";\nimport \"./earth.css\";\nimport \"./d3tip.css\";\n\nconst draw = props => {\n  /*\n    d3.select('.vis-barchart > *').remove();\n    const data = props.data;\n    const margin = {top: 20, right: 20, bottom: 30, left: 40};\n    const width = props.width - margin.left - margin.right;\n    const height = props.height - margin.top - margin.bottom;\n    let svg = d3.select('.vis-barchart').append('svg')\n            .attr('width',width + margin.left + margin.right)\n            .attr('height',height + margin.top + margin.bottom)\n            .append(\"g\")\n            .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n     // format the data\n    data.forEach(function(d) {\n        d.age = +d.age;\n    });\n     // Scale the range of the data in the domains\n    let x = d3.scaleBand()\n          .range([0, width])\n          .padding(0.1);\n    let y = d3.scaleLinear()\n          .range([height, 0]);\n    x.domain(data.map(function(d) { return d.name; }));\n    y.domain([0, d3.max(data, function(d) { return d.age; })]);\n     // append the rectangles for the bar chart\n    svg.selectAll(\".bar\")\n        .data(data)\n        .enter().append(\"rect\")\n        .attr(\"class\", \"bar\")\n        .attr(\"x\", function(d) { return x(d.name); })\n        .attr(\"width\", x.bandwidth())\n        .attr(\"y\", function(d) { return y(d.age); })\n        .attr(\"height\", function(d) { return height - y(d.age); });\n     // add the x Axis\n    svg.append(\"g\")\n        .attr(\"transform\", \"translate(0,\" + height + \")\")\n        .call(d3.axisBottom(x));\n     // add the y Axis\n    svg.append(\"g\")\n        .call(d3.axisLeft(y));\n      */\n  //d3.select(\"#svgID\").remove(); //删除整个SVG\n  //d3.select(\"#svgID\").selectAll(\"*\").remove(); //清空SVG中的内容\n  const {\n    data,\n    h,\n    w,\n    attr\n  } = props;\n  let svg = d3.select(\".vis-barchart\").append(\"svg\").attr(\"height\", h).attr(\"width\", w).attr(\"class\", \"svgs\").attr(\"id\", \"mainsvg\");\n  const width = +svg.attr(\"width\");\n  const height = +svg.attr(\"height\");\n  const margin = {\n    top: 20,\n    right: 20,\n    bottom: 20,\n    left: 20\n  };\n  const innerWidth = width - margin.left - margin.right;\n  const innerHeight = height - margin.top - margin.bottom;\n  const g = svg.append(\"g\").attr(\"id\", \"maingroup\").attr(\"transform\", `translate(${margin.top}, ${margin.right})`);\n  const projection = d3.geoNaturalEarth1(); //const projection = d3.geoTransverseMercator();\n\n  const pathGenerator = d3.geoPath().projection(projection); // setting up the tip tool;\n\n  /*\n  const tip = d3\n    .tip()\n    .attr(\"class\", \"d3-tip\")\n    .html(function (d) {\n      return d.properties.name;\n    });\n  svg.call(tip);\n    */\n\n  let worldmeta;\n  let lastid = undefined; // convert topo-json to geo-json;\n\n  worldmeta = feature(data, data.objects.countries); // this code is really important if you want to fit your geoPaths (map) in your SVG element;\n\n  projection.fitSize([innerWidth, innerHeight], worldmeta); // perform data-join;\n\n  const paths = g.selectAll(\"path\").data(worldmeta.features, d => d.properties.name).enter().append(\"path\").attr(\"d\", pathGenerator).attr(\"stroke\", \"black\").attr(\"stroke-width\", 1).on(\"mouseover\", function (d) {\n    d3.select(this).attr(\"opacity\", 0.5).attr(\"stroke\", \"white\").attr(\"stroke-width\", 3);\n  }).on(\"mouseout\", function (d) {\n    //不能用箭头函数\n    d3.select(this).attr(\"opacity\", 1).attr(\"stroke\", \"black\").attr(\"stroke-width\", 1);\n  });\n  Promise.all([tsv(\"https://unpkg.com/world-atlas@1.1.4/world/50m.tsv\"), json(\"https://unpkg.com/world-atlas@1.1.4/world/50m.json\")]).then(([tsvData, topoJSONdata]) => {\n    // parses tsvData to extract country names for base map titles\n    const countryName = {};\n    tsvData.forEach(d => {\n      countryName[d.iso_n3] = d.name;\n    });\n    console.log(countryName); // draws a path for each country with countryName as title (shown on hover)\n\n    const countries = feature(topoJSONdata, topoJSONdata.objects.countries);\n    g.selectAll(\"path\").data(countries.features).enter().append(\"path\").attr(\"class\", \"country\").attr(\"d\", pathGenerator).append(\"title\").text(d => countryName[d.id]);\n  });\n\n  const radiusValue = d => d[`${attr}`];\n\n  const sizeScale = scaleSqrt().domain([0, max(data, d => d[`${attr}`], radiusValue)]).range([0, 5]);\n  g.selectAll(\"circle\").data(data).enter().append(\"circle\").attr(\"class\", \"country-circle\") // setting x and y coordiantes by translating country coordinate data to pixels\n  .attr(\"transform\", function (d) {\n    return \"translate(\" + projection([d.countryInfo.long, d.countryInfo.lat]) + \")\";\n  }).attr(\"r\", d => sizeScale(radiusValue(d))).attr(\"fill\", color(attr)).append(\"title\"); //.text(\n  // (d) => d.country + \" \" + caseTitle + \": \" + format(\",\")(d[`${caseType}`])\n  //);\n\n  /*\n  svg.call(\n    zoom().on(\"zoom\", () => {\n      g.attr(\"transform\", event.transform);\n    })\n  );\n  */\n\n  /*\n  .on(\"contextmenu\", function (d) {\n    //d3.event.preventDefault();\n    if (lastid !== d.properties.name) {\n      tip.show(d);\n      lastid = d.properties.name;\n    } else {\n      tip.hide(d);\n    }\n  });\n  */\n};\n\nexport default draw;","map":{"version":3,"sources":["/Users/panqp/Documents/React/hw4/src/charts/BarChart/vis.js"],"names":["d3","select","geoNaturalEarth1","scaleSqrt","max","format","selectAll","tsv","json","d3Tip","feature","draw","props","data","h","w","attr","svg","append","width","height","margin","top","right","bottom","left","innerWidth","innerHeight","g","projection","pathGenerator","geoPath","worldmeta","lastid","undefined","objects","countries","fitSize","paths","features","d","properties","name","enter","on","Promise","all","then","tsvData","topoJSONdata","countryName","forEach","iso_n3","console","log","text","id","radiusValue","sizeScale","domain","range","countryInfo","long","lat","color"],"mappings":"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","sourcesContent":["import * as d3 from \"d3\";\nimport {\n  select,\n  geoNaturalEarth1,\n  scaleSqrt,\n  max,\n  format,\n  selectAll,\n  tsv,\n  json,\n} from \"d3\";\nimport d3Tip from \"d3-tip\";\nimport { feature } from \"topojson\";\nimport \"./style.css\";\nimport \"./earth.css\";\nimport \"./d3tip.css\";\nconst draw = (props) => {\n  /*\n    d3.select('.vis-barchart > *').remove();\n    const data = props.data;\n    const margin = {top: 20, right: 20, bottom: 30, left: 40};\n    const width = props.width - margin.left - margin.right;\n    const height = props.height - margin.top - margin.bottom;\n    let svg = d3.select('.vis-barchart').append('svg')\n            .attr('width',width + margin.left + margin.right)\n            .attr('height',height + margin.top + margin.bottom)\n            .append(\"g\")\n            .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n    // format the data\n    data.forEach(function(d) {\n        d.age = +d.age;\n    });\n\n    // Scale the range of the data in the domains\n    let x = d3.scaleBand()\n          .range([0, width])\n          .padding(0.1);\n    let y = d3.scaleLinear()\n          .range([height, 0]);\n    x.domain(data.map(function(d) { return d.name; }));\n    y.domain([0, d3.max(data, function(d) { return d.age; })]);\n\n    // append the rectangles for the bar chart\n    svg.selectAll(\".bar\")\n        .data(data)\n        .enter().append(\"rect\")\n        .attr(\"class\", \"bar\")\n        .attr(\"x\", function(d) { return x(d.name); })\n        .attr(\"width\", x.bandwidth())\n        .attr(\"y\", function(d) { return y(d.age); })\n        .attr(\"height\", function(d) { return height - y(d.age); });\n\n    // add the x Axis\n    svg.append(\"g\")\n        .attr(\"transform\", \"translate(0,\" + height + \")\")\n        .call(d3.axisBottom(x));\n\n    // add the y Axis\n    svg.append(\"g\")\n        .call(d3.axisLeft(y));\n\n\n    */\n  //d3.select(\"#svgID\").remove(); //删除整个SVG\n  //d3.select(\"#svgID\").selectAll(\"*\").remove(); //清空SVG中的内容\n  const { data, h, w, attr } = props;\n  let svg = d3\n    .select(\".vis-barchart\")\n    .append(\"svg\")\n    .attr(\"height\", h)\n    .attr(\"width\", w)\n    .attr(\"class\", \"svgs\")\n    .attr(\"id\", \"mainsvg\");\n  const width = +svg.attr(\"width\");\n  const height = +svg.attr(\"height\");\n  const margin = { top: 20, right: 20, bottom: 20, left: 20 };\n  const innerWidth = width - margin.left - margin.right;\n  const innerHeight = height - margin.top - margin.bottom;\n  const g = svg\n    .append(\"g\")\n    .attr(\"id\", \"maingroup\")\n    .attr(\"transform\", `translate(${margin.top}, ${margin.right})`);\n  const projection = d3.geoNaturalEarth1();\n  //const projection = d3.geoTransverseMercator();\n  const pathGenerator = d3.geoPath().projection(projection);\n\n  // setting up the tip tool;\n  /*\n  const tip = d3\n    .tip()\n    .attr(\"class\", \"d3-tip\")\n    .html(function (d) {\n      return d.properties.name;\n    });\n  svg.call(tip);\n    */\n  let worldmeta;\n  let lastid = undefined;\n\n  // convert topo-json to geo-json;\n  worldmeta = feature(data, data.objects.countries);\n\n  // this code is really important if you want to fit your geoPaths (map) in your SVG element;\n  projection.fitSize([innerWidth, innerHeight], worldmeta);\n\n  // perform data-join;\n  const paths = g\n    .selectAll(\"path\")\n    .data(worldmeta.features, (d) => d.properties.name)\n    .enter()\n    .append(\"path\")\n    .attr(\"d\", pathGenerator)\n    .attr(\"stroke\", \"black\")\n    .attr(\"stroke-width\", 1)\n    .on(\"mouseover\", function (d) {\n      d3.select(this)\n        .attr(\"opacity\", 0.5)\n        .attr(\"stroke\", \"white\")\n        .attr(\"stroke-width\", 3);\n    })\n    .on(\"mouseout\", function (d) {\n      //不能用箭头函数\n      d3.select(this)\n        .attr(\"opacity\", 1)\n        .attr(\"stroke\", \"black\")\n        .attr(\"stroke-width\", 1);\n    });\n  Promise.all([\n    tsv(\"https://unpkg.com/world-atlas@1.1.4/world/50m.tsv\"),\n    json(\"https://unpkg.com/world-atlas@1.1.4/world/50m.json\"),\n  ]).then(([tsvData, topoJSONdata]) => {\n    // parses tsvData to extract country names for base map titles\n    const countryName = {};\n    tsvData.forEach((d) => {\n      countryName[d.iso_n3] = d.name;\n    });\n    console.log(countryName);\n    // draws a path for each country with countryName as title (shown on hover)\n    const countries = feature(topoJSONdata, topoJSONdata.objects.countries);\n    g.selectAll(\"path\")\n      .data(countries.features)\n      .enter()\n      .append(\"path\")\n      .attr(\"class\", \"country\")\n      .attr(\"d\", pathGenerator)\n      .append(\"title\")\n      .text((d) => countryName[d.id]);\n  });\n  const radiusValue = (d) => d[`${attr}`];\n\n  const sizeScale = scaleSqrt()\n    .domain([0, max(data, (d) => d[`${attr}`], radiusValue)])\n    .range([0, 5]);\n\n  g.selectAll(\"circle\")\n    .data(data)\n    .enter()\n    .append(\"circle\")\n    .attr(\"class\", \"country-circle\")\n    // setting x and y coordiantes by translating country coordinate data to pixels\n    .attr(\"transform\", function (d) {\n      return (\n        \"translate(\" + projection([d.countryInfo.long, d.countryInfo.lat]) + \")\"\n      );\n    })\n    .attr(\"r\", (d) => sizeScale(radiusValue(d)))\n    .attr(\"fill\", color(attr))\n    .append(\"title\");\n  //.text(\n  // (d) => d.country + \" \" + caseTitle + \": \" + format(\",\")(d[`${caseType}`])\n  //);\n\n  /*\n  svg.call(\n    zoom().on(\"zoom\", () => {\n      g.attr(\"transform\", event.transform);\n    })\n  );\n*/\n  /*\n  .on(\"contextmenu\", function (d) {\n    //d3.event.preventDefault();\n    if (lastid !== d.properties.name) {\n      tip.show(d);\n      lastid = d.properties.name;\n    } else {\n      tip.hide(d);\n    }\n  });\n  */\n};\n\nexport default draw;\n"]},"metadata":{},"sourceType":"module"}