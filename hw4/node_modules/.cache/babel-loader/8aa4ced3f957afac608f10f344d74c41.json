{"ast":null,"code":"import * as d3 from \"d3\";\nimport rd3 from \"react-d3-library\";\nimport { select, geoNaturalEarth1, scaleLinear, max, format, selectAll, tsv, json } from \"d3\";\nimport { color } from \"../../d3/Color\";\nimport tip from \"d3-tip\";\nimport { feature } from \"topojson\";\nimport \"./style.css\";\nimport \"./earth.css\";\nimport \"./d3tip.css\";\n\nconst draw = props => {\n  d3.select(\"#mainsvg\").remove(); //删除整个SVG\n\n  d3.select(\"#mainsvg\").selectAll(\"*\").remove(); //清空SVG中的内容\n\n  const {\n    data,\n    h,\n    w,\n    attr,\n    year,\n    onSelectCountry\n  } = props;\n  let svg = d3.select(\".vis-barchart\").append(\"svg\") //.attr(\"viewBox\", [0, 0, w, h])\n  .attr(\"height\", h).attr(\"width\", w).attr(\"class\", \"svgs\").attr(\"id\", \"mainsvg\");\n  const width = +svg.attr(\"width\");\n  const height = +svg.attr(\"height\"); //const margin = { top: 20, right: 20, bottom: 20, left: 20 };\n  //const innerWidth = width - margin.left - margin.right;\n  //const innerHeight = height - margin.top - margin.bottom;\n\n  const innerWidth = width;\n  const innerHeight = height;\n  const g = svg.append(\"g\").attr(\"id\", \"maingroup\"); //.attr(\"transform\", `translate(${margin.top}, ${margin.right})`);\n\n  const projection = d3.geoNaturalEarth1();\n  const pathGenerator = d3.geoPath().projection(projection);\n  let lastid = undefined;\n  Promise.all([tsv(\"https://unpkg.com/world-atlas@1.1.4/world/50m.tsv\"), json(\"https://unpkg.com/world-atlas@1.1.4/world/50m.json\")]).then(([tsvData, topoJSONdata]) => {\n    // parses tsvData to extract country names for base map titles\n    const countryName = {};\n    const countryCode = {};\n    tsvData.forEach(d => {\n      countryName[d.iso_n3] = d.name;\n      countryCode[d.iso_n3] = d.iso_a3;\n    }); // draws a path for each country with countryName as title (shown on hover)\n\n    var worldmeta = feature(topoJSONdata, topoJSONdata.objects.countries);\n    projection.fitSize([innerWidth, innerHeight], worldmeta);\n\n    const radiusValue = d => +d.datum > 0 ? +d.datum : -+d.datum;\n\n    const sign = d => +d.datum > 0 ? 1 : -1;\n\n    const findColor = d => {\n      const temp = data.filter(c => c.code === d); //console.log(temp);\n\n      if (temp[0] != null) return temp[0].datum;else return 20;\n    };\n\n    const sizeScale = scaleLinear().domain([0, max(data, d => +d.datum, radiusValue)]).range([0, 255]);\n    const sizeScale2 = scaleLinear().domain([0, max(data, d => +d.datum, radiusValue)]).range([0, 15]);\n    console.log(findColor(countryCode[144])); //console.log(color(sizeScale(data[143].datum)));\n\n    console.log(worldmeta.features);\n    const paths = g.selectAll(\".map\").data(worldmeta.features).enter().append(\"path\").attr(\"d\", pathGenerator).attr(\"class\", \"map\").attr(\"stroke\", \"black\").attr(\"stroke-width\", 1).text(d => countryCode[d.id]).attr(\"fill\", d => color(sizeScale(radiusValue(findColor(countryCode[d.id]))))).on(\"click\", function (d) {\n      onSelectCountry(d3.select(this).text());\n    }).on(\"mouseover\", function (d) {\n      d3.select(this).attr(\"opacity\", 0.5).attr(\"stroke\", \"white\").attr(\"stroke-width\", 6);\n    }).on(\"mouseout\", function (d) {\n      //不能用箭头函数\n      d3.select(this).attr(\"opacity\", 1).attr(\"stroke\", \"black\").attr(\"stroke-width\", 1);\n    });\n    /* g.selectAll(\".map\")\n      .data(data)\n      .attr(\"fill\", (d) => color(sizeScale(radiusValue(d))));\n    */\n\n    /*\n    g.selectAll(\"circle\")\n      .data(data)\n      .enter()\n      .append(\"circle\")\n      .attr(\"transform\", function (d) {\n        return \"translate(\" + projection([d.long, d.lat]) + \")\";\n      })\n      //})\n      .attr(\"r\", (d) => sizeScale2(radiusValue(d)))\n      .attr(\"fill\", (d) => color(sign(d)))\n      .attr(\"opacity\", 0.8)\n      .append(\"title\")\n      .text(\n        (d) => d.country + \": \" + d.datum //+ \": \" + format(\",\")(d[`${caseType}`])\n      );\n    */\n  });\n};\n\nexport default draw;","map":{"version":3,"sources":["/Users/panqp/Documents/GitHub/PRP-Project/hw4/src/charts/BarChart/vis.js"],"names":["d3","rd3","select","geoNaturalEarth1","scaleLinear","max","format","selectAll","tsv","json","color","tip","feature","draw","props","remove","data","h","w","attr","year","onSelectCountry","svg","append","width","height","innerWidth","innerHeight","g","projection","pathGenerator","geoPath","lastid","undefined","Promise","all","then","tsvData","topoJSONdata","countryName","countryCode","forEach","d","iso_n3","name","iso_a3","worldmeta","objects","countries","fitSize","radiusValue","datum","sign","findColor","temp","filter","c","code","sizeScale","domain","range","sizeScale2","console","log","features","paths","enter","text","id","on"],"mappings":"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","sourcesContent":["import * as d3 from \"d3\";\nimport rd3 from \"react-d3-library\";\nimport {\n  select,\n  geoNaturalEarth1,\n  scaleLinear,\n  max,\n  format,\n  selectAll,\n  tsv,\n  json,\n} from \"d3\";\n\nimport { color } from \"../../d3/Color\";\nimport tip from \"d3-tip\";\nimport { feature } from \"topojson\";\nimport \"./style.css\";\nimport \"./earth.css\";\nimport \"./d3tip.css\";\nconst draw = (props) => {\n  d3.select(\"#mainsvg\").remove(); //删除整个SVG\n  d3.select(\"#mainsvg\").selectAll(\"*\").remove(); //清空SVG中的内容\n  const { data, h, w, attr, year, onSelectCountry } = props;\n  let svg = d3\n    .select(\".vis-barchart\")\n    .append(\"svg\")\n    //.attr(\"viewBox\", [0, 0, w, h])\n    .attr(\"height\", h)\n    .attr(\"width\", w)\n    .attr(\"class\", \"svgs\")\n    .attr(\"id\", \"mainsvg\");\n\n  const width = +svg.attr(\"width\");\n  const height = +svg.attr(\"height\");\n  //const margin = { top: 20, right: 20, bottom: 20, left: 20 };\n  //const innerWidth = width - margin.left - margin.right;\n  //const innerHeight = height - margin.top - margin.bottom;\n  const innerWidth = width;\n  const innerHeight = height;\n\n  const g = svg.append(\"g\").attr(\"id\", \"maingroup\");\n  //.attr(\"transform\", `translate(${margin.top}, ${margin.right})`);\n  const projection = d3.geoNaturalEarth1();\n  const pathGenerator = d3.geoPath().projection(projection);\n  let lastid = undefined;\n  Promise.all([\n    tsv(\"https://unpkg.com/world-atlas@1.1.4/world/50m.tsv\"),\n    json(\"https://unpkg.com/world-atlas@1.1.4/world/50m.json\"),\n  ]).then(([tsvData, topoJSONdata]) => {\n    // parses tsvData to extract country names for base map titles\n    const countryName = {};\n    const countryCode = {};\n    tsvData.forEach((d) => {\n      countryName[d.iso_n3] = d.name;\n      countryCode[d.iso_n3] = d.iso_a3;\n    });\n    // draws a path for each country with countryName as title (shown on hover)\n    var worldmeta = feature(topoJSONdata, topoJSONdata.objects.countries);\n    projection.fitSize([innerWidth, innerHeight], worldmeta);\n    const radiusValue = (d) => (+d.datum > 0 ? +d.datum : -+d.datum);\n    const sign = (d) => (+d.datum > 0 ? 1 : -1);\n    const findColor = (d) => {\n      const temp = data.filter((c) => c.code === d);\n      //console.log(temp);\n      if (temp[0] != null) return temp[0].datum;\n      else return 20;\n    };\n    const sizeScale = scaleLinear()\n      .domain([0, max(data, (d) => +d.datum, radiusValue)])\n      .range([0, 255]);\n    const sizeScale2 = scaleLinear()\n      .domain([0, max(data, (d) => +d.datum, radiusValue)])\n      .range([0, 15]);\n    console.log(findColor(countryCode[144]));\n\n    //console.log(color(sizeScale(data[143].datum)));\n    console.log(worldmeta.features);\n    const paths = g\n      .selectAll(\".map\")\n      .data(worldmeta.features)\n      .enter()\n      .append(\"path\")\n      .attr(\"d\", pathGenerator)\n      .attr(\"class\", \"map\")\n      .attr(\"stroke\", \"black\")\n      .attr(\"stroke-width\", 1)\n      .text((d) => countryCode[d.id])\n      .attr(\"fill\", (d) =>\n        color(sizeScale(radiusValue(findColor(countryCode[d.id]))))\n      )\n      .on(\"click\", function (d) {\n        onSelectCountry(d3.select(this).text());\n      })\n      .on(\"mouseover\", function (d) {\n        d3.select(this)\n          .attr(\"opacity\", 0.5)\n          .attr(\"stroke\", \"white\")\n          .attr(\"stroke-width\", 6);\n      })\n      .on(\"mouseout\", function (d) {\n        //不能用箭头函数\n        d3.select(this)\n          .attr(\"opacity\", 1)\n          .attr(\"stroke\", \"black\")\n          .attr(\"stroke-width\", 1);\n      });\n\n    /* g.selectAll(\".map\")\n      .data(data)\n      .attr(\"fill\", (d) => color(sizeScale(radiusValue(d))));\n*/\n    /*\n    g.selectAll(\"circle\")\n      .data(data)\n      .enter()\n      .append(\"circle\")\n      .attr(\"transform\", function (d) {\n        return \"translate(\" + projection([d.long, d.lat]) + \")\";\n      })\n      //})\n      .attr(\"r\", (d) => sizeScale2(radiusValue(d)))\n      .attr(\"fill\", (d) => color(sign(d)))\n      .attr(\"opacity\", 0.8)\n      .append(\"title\")\n      .text(\n        (d) => d.country + \": \" + d.datum //+ \": \" + format(\",\")(d[`${caseType}`])\n      );\n\n  */\n  });\n};\n\nexport default draw;\n"]},"metadata":{},"sourceType":"module"}